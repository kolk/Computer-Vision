% img1Pts = [314, 306, 1;
%     435, 302, 1;
%     559, 307, 1;
%     691, 311, 1;
%     804, 306, 1;
%     935, 309, 1;
%     1065, 306, 1;
%     1189, 309, 1;
%     1319, 315, 1;
%     1446, 315, 1;
%     1577, 312, 1;
%     1701, 318, 1;
%     1843, 318, 1;
%     1980, 315, 1;
%     2116, 314, 1;
%     2253, 318, 1;
%     2395, 312, 1;
%     2532, 312, 1;
%     2687, 315, 1;
%     
%     321, 563, 1;
%     445, 566, 1;
%     566, 570, 1;
%     690, 566, 1;
%     817, 570, 1;
%     941, 570, 1;
%     1065, 576, 1;
%     1195, 579, 1;
%     1322, 579, 1;
%     1450, 579, 1;
%     1574, 582, 1;
%     1707, 588, 1;
%     1837, 585,1;
%     1971, 591, 1;
%     2140, 591, 1;
%     2243, 591, 1;
%     2383, 594, 1;
%     2519, 594, 1;
%     2665, 594, 1;
%     
%     324, 821, 1;
%     445, 824, 1;
%     569, 821, 1;
%     690. 824, 1;
%     814, 833, 1;
%     941, 836, 1;
%     1065, 830, 1;
%     1189, 836, 1;
%     1322, 839, 1;
%     1450, 839, 1;
%     1570, 846, 1;
%     1698, 846, 1;
%     1834, 852, 1;
%     1964, 855, 1;
%     2098, 858, 1;
%     2231, 861, 1;
%     2368, 864, 1;
%     2510, 870, 1;
%     2656, 870, 1;
%     
%     327, 1066, 1;
%     445, 1072, 1;
%     569, 1072, 1;
%     690, 1078, 1;
%     817, 1078, 1;
%     944, 1081, 1;
%     1068, 1084, 1;
%     1192, 1088, 1;
%     1319, 1094, 1;
%     1443, 1097, 1;
%     1570, 1103, 1;
%     1695, 1103, 1;
%     1828, 1106, 1;
%     1958, 1112, 1;
%     2088, 1119, 1;
%     2228, 1128, 1;
%     2355, 1128, 1;
%     2504, 1137, 1;
%     2644, 1140, 1;
%     
%     333, 1317, 1;
%     451, 1317, 1;
%     575, 1320, 1;
%     696, 1323, 1;
%     820, 1326, 1;
%     947, 1333, 1;
%     1068, 1336, 1;
%     1192, 1339, 1;
%     1319, 1345, 1;
%     1443, 1345, 1;
%     1567, 1354, 1;
%     1698, 1360, 1;
%     1825, 1367, 1;
%     1952, 1370, 1;
%     2082, 1379, 1;
%     2215, 1382, 1;
%     2352, 1395, 1;
%     2492, 1401, 1;
%     2634, 1407, 1];
% 
% img2Pts = [ 
%     539, 167, 1;
%     699, 175, 1;
%     866, 187, 1;
%     1022, 199, 1;
%     1175, 206, 1;
%     1323, 223, 1;
%     1467, 227, 1;
%     1607, 243, 1;
%     1747, 247, 1;
%     1882, 259, 1;
%     2006, 271, 1;
%     2139, 279, 1;
%     2263, 283, 1;
%     2387, 295, 1;
%     2507, 299, 1;
%     2619, 303, 1;
%     2739, 315, 1;
%     2855, 327, 1;
%     2967, 331, 1;
%     
%     547, 482, 1;
%     707, 486, 1;
%     862, 498, 1;
%     1014, 506, 1;
%     1175, 510, 1;
%     1323, 522, 1;
%     1455, 518, 1;
%     1595, 530, 1;
%     1735, 535, 1;
%     1866, 546, 1;
%     1990, 546, 1;
%     2119, 554, 1;
%     2243, 554, 1;
%     2359, 558, 1;
%     2483, 562, 1;
%     2599, 574, 1;
%     2719, 578, 1;
%     2831, 586, 1;
%     2943, 586, 1;
%     
%     541, 795, 1;
%     715, 794, 1;
%     866, 798, 1;
%     1018, 807, 1;
%     1171, 806, 1;
%     1315, 806, 1;
%     1451, 806, 1;
%     1587, 815, 1;
%     1723, 810, 1;
%     1846, 819, 1;
%     1974, 815, 1;
%     2099, 823, 1;
%     2215, 819, 1;
%     2343, 827, 1;
%     2459, 831, 1;
%     2575, 823, 1;
%     2691, 827, 1;
%     2807, 831, 1;
%     2911, 837, 1;
%     
%     551, 1091, 1;
%     711, 1091, 1;
%     862, 1091, 1;
%     1010, 1091, 1;
%     1163, 1083, 1;
%     1307, 1079, 1;
%     1447, 1083, 1;
%     1575, 1087, 1;
%     1711, 1083, 1;
%     1830, 1083, 1;
%     1962, 1071, 1;
%     2083, 1075, 1;
%     2203, 1083, 1;
%     2323, 1079, 1;
%     2435, 1075, 1;
%     2551, 1071, 1;
%     2671, 1087, 1;
%     2783, 1083, 1;
%     2887, 1087, 1;
%     
%     547, 1383, 1;
%     711, 1383, 1;
%     866, 1367, 1;
%     1010, 1367, 1;
%     1159, 1359, 1;
%     1291, 1351, 1;
%     1435, 1347, 1;
%     1567, 1347, 1;
%     1695, 1339, 1;
%     1818, 1339, 1;
%     1942, 1335, 1;
%     2063, 1327, 1;
%     2187, 1331, 1;
%     2303, 1331, 1;
%     2419, 1327, 1;
%     2527, 1323, 1;
%     2639, 1319, 1;
%     2751, 1319, 1;
%     2867, 1323, 1;
%     ];




function [p, K, R, C, imgEstimated] = ransac(img2Pts, img1Pts, I1, I2)
%close all;

%      I1 = imresize(imread('lap1.jpg'), 0.5);
%      I2 = imresize(imread('lap2.jpg'),0.5);
%     figure;
%     imshow(I1);
%     figure;
%     imshow(I2);


%points of lap1
%     lap2Pts = [558, 580, 1;
%         1240, 98, 1;
%         850, 502, 1;
%         1088,664, 1;
%         382, 624, 1;
%         842, 272, 1;
%         570, 504, 1;
%         542, 462, 1;
%         1364, 608, 1;
%         1160, 646, 1;
%         236, 616, 1;
%         964, 786, 1;
%         1510, 576, 1;
%         1252, 498, 1;
%         730, 426, 1;
%         198, 788, 1
%     ];
% 
% %points of lap2
%     lap1Pts = [ 648, 572, 1;
%         1168, 18, 1;
%         908, 454, 1;
%         1188, 568, 1;
%         486, 652, 1;
%         822, 238, 1;
%         638, 504, 1;
%         588, 468, 1;
%         1402, 474, 1;
%         1244, 540, 1;
%         320, 676, 1;
%         1120, 700, 1;
%         1478, 436, 1;
%         1266, 390, 1;
%         764, 400, 1;
%         346, 864, 1
%         ];
%     
%    img2Pts = [658, 120, 1;
%         784, 624, 1;
%         402, 116, 1;
%         1592, 164, 1;
%          
%         318, 746, 1;
%          576, 136, 1;
%          712, 254, 1;
%          610, 190, 1;
%          484, 258, 1
%         ];
%     img1Pts = [670, 120, 1;
%         794, 622, 1;
%         420, 118, 1;
%         1592, 180, 1;
% 
%         336, 754, 1;
%         592, 140, 1;
%         726, 258, 1;
%         622, 188, 1;
%         496, 254, 1
%       ];
%     
%     img2Pts = lap2Pts;
%     img1Pts = lap1Pts;
'inside ransac'
 err = 0;
mnErr = 5000000;
p = zeros(3,3);

m = size(img1Pts,1);
n = randperm(m);

im1 = img1Pts(n,:);
im2 = img2Pts(n,:);
choseni = 1;

ptsChosenIndx = [];
for iter = 1:10
   
   indices = randperm(m, 4);
   imP1 = im1(indices,:);
   imP2 = im2(indices, :);
    P = dlt(imP2, imP1);
   estimatedI2 = P*im1';
   estimatedI2 = round(estimatedI2 ./ repmat(estimatedI2(3,:),3,1))';
   diff = im2 - estimatedI2;
   err = sum(sqrt(sum((im2 - estimatedI2).^2,2)))/m;
   if mnErr >= err
       p = P;
       mnErr = err;
       choseni = iter;
   end
   
   
% figure;
% imshow(I2);
% hold on;
% plot(im2(:,1), im2(:,2), 'r*', 'LineWidth',3);
% plot(estimatedI2(:,1), estimatedI2(:,2), 'bo', 'LineWidth',2);  

end

% ptsChosenIndx
 mnErr
'finalP'
p
estimatedImg = p*img1Pts';
imgEstimated = round(estimatedImg ./ repmat(estimatedImg(3,:),3,1))';
H = p(:,1:3);
invH = inv(H);
[invR, invK] = qr(invH);
 R = invR'
 K = inv(invK)
 C = invH*p(:,3)
% 
% 
% figure;
% imshow(I1);
% hold on;
% plot(img2Pts(:,1), img2Pts(:,2), 'r*', 'LineWidth',5);
% plot(imgEstimated(:,1), imgEstimated(:,2), 'yo', 'LineWidth',2);  
% legend('actual Points','estimated points')  
end