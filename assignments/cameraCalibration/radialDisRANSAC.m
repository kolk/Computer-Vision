% clear all;
% clc;
% imgPts = [14, 27, 1;
% 91, 34, 1;
% 166, 37, 1;
% 245, 44, 1;
% 325, 47, 1;
% 407, 52, 1;
% 493, 57, 1;
% 20, 104, 1;
% 94, 110, 1;
% 168, 117, 1;
% 245, 122, 1;
% 323, 128, 1;
% 404, 134, 1;
% 488, 140, 1;
% 398, 209, 1;
% 474, 246, 1;
% 465, 279, 1;
% 455, 316, 1;
% 444, 360, 1;
% 387, 236, 1;
% 304, 231, 1;
% 224, 223, 1;
% 114, 216, 1;
% 66, 210, 1;
% 34, 240, 1;
% 117, 246, 1;
% 200, 254, 1;
% 285, 263, 1;
% 373, 271, 1;
% 357, 308, 1;
% 263, 299, 1;
% 172, 291, 1;
% 83, 282, 1;
% 46, 322, 1;
% 142, 331, 1;
% 238, 341, 1;
% 338, 350, 1];  
% 
% worldPts = [216, 72, 0, 1;
% 180, 72, 0, 1;
% 144, 72, 0, 1;
% 108, 72, 0, 1;
% 72, 72, 0, 1;
% 36, 72, 0, 1;
% 0, 72, 0, 1;
% 216, 36, 0, 1;
% 180, 36, 0, 1;
% 144, 36, 0, 1;
% 108, 36, 0, 1;
% 72, 36, 0, 1;
% 36, 36, 0, 1;
% 0, 36, 0, 1;
% 36, 0, 0, 1
% 0, 0, 36, 1;
% 0, 0, 72, 1;
% 0, 0, 108, 1;
% 0, 0, 144, 1;
% 36, 0, 36, 1;
% 72, 0, 36, 1;
% 108, 0, 36, 1;
% 144, 0, 36, 1;
% 216, 0, 36, 1;
% 216, 0, 72, 1;
% 144, 0, 72, 1;
% 108, 0, 72, 1;
% 72, 0, 72, 1;
% 36,0, 72, 1;
% 36, 0, 108, 1;
% 72, 0, 108, 1;
% 108, 0, 108, 1;
% 144, 0, 108, 1;
% 144, 0, 144, 1;
% 108, 0, 144, 1;
% 72, 0, 144, 1;
% 36, 0, 144, 1];

%function [p, K, R, C, imgEstimated] = RANSAC(imgPts, worldPts)
err = 0;
mnErr = 5000000;
p = zeros(3,4);
est = zeros(size(imgPts));

for iter = 1:1000
   indices = randperm(size(worldPts, 1), 6);
   P = DLT(imgPts(indices,:), worldPts(indices, :));
   estimatedImg = P*worldPts';
   imgEstimated = round(estimatedImg ./ repmat(estimatedImg(3,:),3,1))';
   err = sum(sqrt(sum((imgPts - imgEstimated).^2,2)))/size(imgPts,1);
   if mnErr >= err
       p = P;
       mnErr = err;
   end
end

mnErr
estimatedImg = p*worldPts';
imgEstimated = round(estimatedImg ./ repmat(estimatedImg(3,:),3,1))';
H = p(:,1:3);
invH = inv(H);
[invR, invK] = qr(invH);
 R = invR';
 K = inv(invK);
 C = invH*p(:,4);
%end